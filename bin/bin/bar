#!/bin/bash
pkill lemonbar

# colors
trans='#00000000'
gray='#7c6f64'
black='#3c3836'
white='#fbf1c7'
red='#cc241d'
green='#98971a'
yellow='#d79921'
blue='#458588'
purple='#b16286'
aqua='#689d6a'
orange='#d65d0e'

workspaces() {
	cur=`xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}'`
	tot=`xprop -root _NET_NUMBER_OF_DESKTOPS | awk '{print $3}'`

	for w in `seq 0 $((cur - 1))`; do line="${line} %{F${gray}}%{F-}"; done
	line="${line} %{F${red}}%{F-}"
	for w in `seq $((cur + 2)) $tot`; do line="${line} %{F${gray}}%{F-}"; done
	echo %{B${black}} $line %{B-}
}

clock() {
	mtime=$(date +'%H:%M')
	myear=$(date +'%Y-%m-')
	mday=$(date +'%d')
	echo %{B${black}} $mtime %{F${gray}}$myear%{F-}$mday %{B-}
}

cpu() {
	cpu=$(cat <(grep 'cpu ' /proc/stat) <(sleep 2s && grep 'cpu ' /proc/stat) | awk -v RS="" '{printf "%.2f\n", ($13-$2+$15-$4)*100/($13-$2+$15-$4+$16-$5)}')

	icon="%{B${yellow}}   %{B-}%{B${black}}%{F${yellow}}%{F-} "
	echo $icon$cpu"% "
}

mem() {
	ram=`free | awk '/Mem:/ {print int($3/$2 * 100.0)}'`

	icon="%{B${orange}}%{F${black}}%{F-}   %{B-}%{B${black}}%{F${orange}}%{F-} "
	echo $icon$ram"% "
}

net() {
	network_id=$(iwgetid -r)
	if [ -n "$network_id" ]
	then
		icon="   "
		net="wlp1s0"
	else
		icon="   "
		net="enp2s0"
	fi

	icon="%{B${blue}}%{F${black}}%{F-}${icon}%{B-}%{B${black}}%{F${blue}}%{F-} "
	echo $icon$net
}

bat() {
	BATPATH=/sys/class/power_supply/BAT1
	CAPACITY=$BATPATH/capacity
	STATUS=$BATPATH/status
	cap=$(cat $CAPACITY)
	stat=$(cat $STATUS)
	case $stat in
		Full)
			st="="
			;;
		Discharging)
			st="-"
			;;
		Charging)
			st="+"
			;;
		Unknown)
			st="~"
			;;
	esac

	case $cap in
		0|[1-9]|[1-2][0-5])
			icon="   "
			;;
		2[6-9]|[3-4][0-9])
			icon="   "
			;;
		[5-6][0-9]|7[0-5])
			icon="   "
			;;
		7[6-9]|[8-9][0-9])
			icon="   "
			;;
		100)
			icon="   "
			;;
	esac

	icon="%{B${aqua}}%{F${black}}%{F-}${icon}%{B-}%{B${black}}%{F${aqua}}%{F-} "
	echo $icon$st$cap"%"
}

vol() {
	snd_cha=$(amixer get Master | grep "Playback channels:" | awk '{if ($4 == "") {printf "%s: Playback", $3} else {printf "%s %s: Playback", $3, $4}}')
	snd=$(amixer get Master | grep "$snd_cha" | awk -F'[]%[]' '/%/ {if ($7 == "off") {print "X\n"} else {printf "%d\n", $2}}')

	case $snd in
		X|0)
			icon="   "
		;;
		[1-9]|[1-4][0-9])
			icon="   "
		;;
		[5-9][0-9]|100)
			icon="   "
		;;
	esac

	icon="%{B${purple}}%{F${black}}%{F-}${icon}%{B-}%{B${black}}%{F${purple}}%{F-} "
	printf "%-99.99s\n" "$icon$snd% "
#	echo $icon$snd"% "
}

left() {
	while :; do
		buf="$(workspaces)"

		echo $buf
		sleep 0.9s
	done |\

	lemonbar -g '248x30+10+10' \
			 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
			 -B "${trans}" \
			 -F "${white}"
}

center() {
	while :; do
		buf="$(clock)"

		echo $buf
		sleep 2s
	done |\

	lemonbar -g '144x30+888+10' \
			 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
			 -B "${trans}" \
			 -F "${white}"
}

right() {
	while :; do
		buf="%{B${black}}$(cpu) $(mem) $(net) $(bat) $(vol)%{B-}"

		echo $buf
	done |\

	lemonbar -g '502x30+1408+10' \
			 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
			 -B "${trans}" \
			 -F "${white}"
}

main() {
	left &
	center &
	right
}

main
