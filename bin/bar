#!/bin/bash
pkill lemonbar

# colors
gray='#7c6f64'
black='#3c3836'
white='#fbf1c7'
red='#cc241d'
green='#98971a'
yellow='#d79921'
blue='#458588'
purple='#b16286'
aqua='#689d6a'
orange='#d65d0e'

workspaces() {
	cur=`xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}'`
	tot=`xprop -root _NET_NUMBER_OF_DESKTOPS | awk '{print $3}'`

	for w in `seq 0 $((cur - 1))`; do line="${line} %{F${gray}}%{F-}"; done
	line="${line} %{F${red}}%{F-}"
	for w in `seq $((cur + 2)) $tot`; do line="${line} %{F${gray}}%{F-}"; done
	echo %{B${black}} $line %{B-}
}

clock() {
	mtime=$(date +'%H:%M')
	myear=$(date +'%Y-%m-')
	mday=$(date +'%d')
	echo %{B${black}} $mtime %{F${gray}}$myear%{F-}$mday %{B-}
}

cpu() {
	cpu=$(cat <(grep 'cpu ' /proc/stat) <(sleep 2s && grep 'cpu ' /proc/stat) | awk -v RS="" '{printf "%.2f\n", ($13-$2+$15-$4)*100/($13-$2+$15-$4+$16-$5)}')

	icon="%{B${yellow}}   %{B-}%{B${black}}%{F${yellow}}%{F-} "
	echo $icon
	printf '%06.2f' $cpu
	echo "% "
}

mem() {
	ram=`free | awk '/Mem:/ {print int($3/$2 * 100.0)}'`

	icon="%{B${orange}}%{F${black}}%{F-}   %{B-}%{B${black}}%{F${orange}}%{F-} "
	echo $icon
	printf '%03d' $ram
	echo "% "
}

net() {
	network_id=$(iwgetid -r)
	if [ -n "$network_id" ]
	then
		icon="   "
		net="wlp1s0"
	else
		icon="   "
		net="enp2s0"
	fi

	icon="%{B${blue}}%{F${black}}%{F-}${icon}%{B-}%{B${black}}%{F${blue}}%{F-} "
	echo $icon$net
}

vol() {
	snd_cha=$(amixer get Master | grep "Playback channels:" | awk '{if ($4 == "") {printf "%s: Playback", $3} else {printf "%s %s: Playback", $3, $4}}')
	snd=$(amixer get Master | grep "$snd_cha" | awk -F'[]%[]' '/%/ {if ($7 == "off") {print "XXX\n"} else {printf "%03d\n", $2}}')

	icon="%{B${purple}}%{F${black}}%{F-}   %{B-}%{B${black}}%{F${purple}}%{F-} "
	echo $icon$snd"% "
}

left() {
	while :; do
		buf="$(workspaces)"

		echo $buf
		sleep 0.7s
	done |\

	lemonbar -g '248x30+10+10' \
			 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
			 -B "${black}" \
			 -F "${white}"
}

center() {
	while :; do
		buf="$(clock)"

		echo $buf
		sleep 2s
	done |\

	lemonbar -g '144x30+888+10' \
			 -f 'Hack:size=10' \
			 -B "${black}" \
			 -F "${white}"
}

right() {
	while :; do
		buf="%{B${black}}$(cpu) $(mem) $(net) $(vol)%{B-}"

		echo $buf
	done |\

	lemonbar -g '538x30+1372+10' \
			 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
			 -B "${black}" \
			 -F "${white}"
}

main() {
	left &
	center &
	right
}

main
