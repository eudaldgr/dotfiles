#!/bin/bash
pkill lemonbar

# colors
foreground=$(xrdb -query | grep "*foreground" | cut -f 2)
background=$(xrdb -query | grep "*background" | cut -f 2)
cursorColor=$(xrdb -query | grep "*cursorColor" | cut -f 2)

color0=$(xrdb -query | grep "*color0"  | cut -f 2)
color1=$(xrdb -query | grep "*color1"  | cut -f 2)
color2=$(xrdb -query | grep "*color2"  | cut -f 2)
color3=$(xrdb -query | grep "*color3"  | cut -f 2)
color4=$(xrdb -query | grep "*color4"  | cut -f 2)
color5=$(xrdb -query | grep "*color5"  | cut -f 2)
color6=$(xrdb -query | grep "*color6"  | cut -f 2)
color7=$(xrdb -query | grep "*color7"  | cut -f 2)
color8=$(xrdb -query | grep "*color8"  | cut -f 2)
color9=$(xrdb -query | grep "*color9"  | cut -f 2)
color10=$(xrdb -query | grep "*color10" | cut -f 2)
color11=$(xrdb -query | grep "*color11" | cut -f 2)
color12=$(xrdb -query | grep "*color12" | cut -f 2)
color13=$(xrdb -query | grep "*color13" | cut -f 2)
color14=$(xrdb -query | grep "*color14" | cut -f 2)
color15=$(xrdb -query | grep "*color15" | cut -f 2)

workspaces() {
	cur=`xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}'`
	tot=`xprop -root _NET_NUMBER_OF_DESKTOPS | awk '{print $3}'`

	for w in `seq 0 $((cur - 1))`; do line="${line} %{F${color7}}%{F-}"; done
	line="${line} %{F${color1}}%{F-}"
	for w in `seq $((cur + 2)) $tot`; do line="${line} %{F${color7}}%{F-}"; done
	echo $line
}

clock() {
	mtime=$(date +'%H:%M')
	myear=$(date +'%Y-%m-')
	mday=$(date +'%d')
	echo $mtime %{F${color7}}$myear%{F-}$mday
}

cpu() {
	cpu=$(cat <(grep 'cpu ' /proc/stat) <(sleep 2s && grep 'cpu ' /proc/stat) | awk -v RS="" '{printf "%.2f\n", ($13-$2+$15-$4)*100/($13-$2+$15-$4+$16-$5)}')

	icon="%{B${color3}}   %{B-}%{B${color15}}%{F${color3}}%{F-} "
	echo $icon
	printf '%06.2f' $cpu
	echo "% "
}

mem() {
	ram=`free | awk '/Mem:/ {print int($3/$2 * 100.0)}'`

	icon="%{B${color6}}%{F${color15}}%{F-}   %{B-}%{B${color15}}%{F${color6}}%{F-} "
	echo $icon
	printf '%03d' $ram
	echo "% "
}

net() {
	if [[ "$(hostname -d)" != "lan" ]]; then
		net="XXX.XXX.X.X"
	else
		net=$(hostname -i)
	fi

	icon="%{B${color4}}%{F${color15}}%{F-}  %{B-}%{B${color15}}%{F${color4}}%{F-} "
	echo $icon$net
}

vol() {
	snd_cha=$(amixer -c 1 get Master | grep "Playback channels:" | awk '{if ($4 == "") {printf "%s: Playback", $3} else {printf "%s %s: Playback", $3, $4}}')
	snd=$(amixer -c 1 get Master | grep "$snd_cha" | awk -F'[]%[]' '/%/ {if ($7 == "off") {print "XXX\n"} else {printf "%03d\n", $2}}')

	icon="%{B${color5}}%{F${color15}}%{F-}   %{B-}%{B${color15}}%{F${color5}}%{F-} "
	echo $icon$snd"% "
}

left() {
	while :; do
		echo " "$(workspaces)
		sleep 0.7s
	done |\

	lemonbar -g '248x30+10+10' \
		 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
		 -B "${color15}"
}

center() {
	while :; do
		echo " "$(clock)
		sleep 2s
	done |\

	lemonbar -g '144x30+888+10' \
		 -f 'Hack:size=10' \
		 -B "${color15}" \
		 -F "${color0}"
}

right() {
	while :; do
		echo $(cpu) $(mem) $(net) $(vol)
	done |\

	lemonbar -g '467x30+1443+10' \
		 -f 'Hack:size=10' -f 'Font Awesome 5 Free Solid:size=12' \
		 -B "${color15}" \
		 -F "${color0}"
}

left &
center &
right
